/*
 * Copyright (c) 2013 Jeremy Pepper
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 *  * Redistributions of source code must retain the above copyright notice,
 *    this list of conditions and the following disclaimer.
 *  * Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 *  * Neither the name of crossfeed nor the names of its contributors may
 *    be used to endorse or promote products derived from this software
 *    without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE
 * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 */

#include "crossfeed.h"
#include <string.h>

static const float kernel_96k[] = {
	-3.77532e-20,0,-7.53649e-07,0,2.67207e-06,0,-7.23353e-06,0,1.11175e-05,0,-2.15723e-05,0,
	2.63209e-05,0,-4.56573e-05,0,4.98091e-05,0,-8.18815e-05,0,8.37892e-05,0,-0.000133168,0,
	0.000131318,0,-0.000202979,0,0.000196519,0,-0.000295306,0,0.000284858,0,-0.000414692,0,
	0.000403489,0,-0.000566267,0,0.000561674,0,-0.000755855,0,0.000771369,0,-0.000990266,0,
	0.00104793,-2.79864e-20,-0.00127774,-4.71559e-07,0.00141123,1.92777e-06,-0.00162883,
	-4.55151e-06,0.00188715,7.75667e-06,-0.00205783,-1.36772e-05,0.00251024,1.76459e-05,-0.00258528,
	-2.92016e-05,0.0033279,3.18912e-05,-0.00324223,-5.28443e-05,0.004408,5.09546e-05,-0.00407807,
	-8.6663e-05,0.00585322,7.55198e-05,-0.00517586,-0.000132986,0.00783035,0.000106589,-0.00668522,
	-0.00019427,0.0106343,0.000145611,-0.00890183,-0.000272896,0.0148494,0.000194686,-0.0124943,
	-0.000370892,0.0218309,0.000256842,-0.019321,-0.000489585,0.0356078,0.000336369,-0.0365672,
	-0.000629164,0.0731005,0.000439151,-0.0835148,-0.000788195,0.00546887,0.000573184,0.387042,
	-0.000963134,-0.0816554,0.000748971,-0.128338,-0.00114777,-0.210263,0.000980097,-0.130048,
	-0.00133269,-0.148752,0.0012837,-0.0828659,-0.00150476,-0.0991994,0.00168106,-0.0514635,
	-0.0016465,-0.0686098,0.0021983,0.967381,-0.00173558,-0.0494284,0.00286726,-0.0210028,
	-0.00174393,-0.0367524,0.00372666,-0.0135239,-0.00163656,-0.0279361,0.00482409,-0.00852371,
	-0.00136998,-0.0215418,0.00621883,-0.00509001,-0.00088901,-0.0167532,0.00798691,-0.00269751,
	-0.000121976,-0.013084,0.0102289,-0.00102796,0.00102796,-0.0102289,0.013084,0.000121976,
	0.00269751,-0.00798691,0.0167532,0.00088901,0.00509001,-0.00621883,0.0215418,0.00136998,
	0.00852371,-0.00482409,0.0279361,0.00163656,0.0135239,-0.00372666,0.0367524,0.00174393,
	0.0210028,-0.00286726,0.0494284,0.00173558,0.0326194,-0.0021983,0.0686098,0.0016465,0.0514635,
	-0.00168106,0.0991994,0.00150476,0.0828659,-0.0012837,0.148752,0.00133269,0.130048,-0.000980097,
	0.210263,0.00114777,0.128338,-0.000748971,0.0816554,0.000963134,-0.387042,-0.000573184,
	-0.00546887,0.000788195,0.0835148,-0.000439151,-0.0731005,0.000629164,0.0365672,-0.000336369,
	-0.0356078,0.000489585,0.019321,-0.000256842,-0.0218309,0.000370892,0.0124943,-0.000194686,
	-0.0148494,0.000272896,0.00890183,-0.000145611,-0.0106343,0.00019427,0.00668522,-0.000106589,
	-0.00783035,0.000132986,0.00517586,-7.55198e-05,-0.00585322,8.6663e-05,0.00407807,-5.09546e-05,
	-0.004408,5.28443e-05,0.00324223,-3.18912e-05,-0.0033279,2.92016e-05,0.00258528,-1.76459e-05,
	-0.00251024,1.36772e-05,0.00205783,-7.75667e-06,-0.00188715,4.55151e-06,0.00162883,-1.92777e-06,
	-0.00141123,4.71559e-07,0.00127774,2.79864e-20,-0.00104793,0,0.000990266,0,-0.000771369,0,
	0.000755855,0,-0.000561674,0,0.000566267,0,-0.000403489,0,0.000414692,0,-0.000284858,0,
	0.000295306,0,-0.000196519,0,0.000202979,0,-0.000131318,0,0.000133168,0,-8.37892e-05,0,
	8.18815e-05,0,-4.98091e-05,0,4.56573e-05,0,-2.63209e-05,0,2.15723e-05,0,-1.11175e-05,0,
	7.23353e-06,0,-2.67207e-06,0,7.53649e-07,0,3.77532e-20
};

static const float kernel_48k[] = {
	2.1816e-20,0,7.01048e-07,0,-7.58757e-06,0,5.67089e-06,0,-3.67541e-05,0,1.63645e-05,0,
	-9.8184e-05,0,4.11781e-05,0,-0.000200637,0,0.000104288,0,-0.000344059,0,0.000258008,0,
	-0.000511006,1.11288e-20,0.000599619,7.67727e-07,-0.00065982,-4.57746e-06,0.00129645,
	4.74738e-06,-0.000723193,-2.57542e-05,0.00263978,6.33339e-06,-0.000615568,-7.83834e-05,
	0.00521695,-1.15223e-06,-0.000276492,-0.000179071,0.0106756,-1.83043e-05,-0.000332889,
	-0.000336304,0.0284488,-2.58284e-05,-0.0381542,-0.000531655,0.3554,3.806e-05,-0.283572,
	-0.000692448,-0.330824,0.000307652,-0.191878,-0.000658758,-0.142028,0.00102426,0.916013,
	-0.0001474,-0.0688206,0.00257599,-0.0410188,0.00129155,-0.0367413,0.0055568,-0.0208017,
	0.00435118,-0.0201928,0.0108944,-0.0101565,0.0101565,-0.0108944,0.0201928,-0.00435118,0.0208017,
	-0.0055568,0.0367413,-0.00129155,0.0410188,-0.00257599,0.0688206,0.0001474,0.0839867,
	-0.00102426,0.142028,0.000658758,0.191878,-0.000307652,0.330824,0.000692448,0.283572,-3.806e-05,
	-0.3554,0.000531655,0.0381542,2.58284e-05,-0.0284488,0.000336304,0.000332889,1.83043e-05,
	-0.0106756,0.000179071,0.000276492,1.15223e-06,-0.00521695,7.83834e-05,0.000615568,-6.33339e-06,
	-0.00263978,2.57542e-05,0.000723193,-4.74738e-06,-0.00129645,4.57746e-06,0.00065982,
	-7.67727e-07,-0.000599619,-1.11288e-20,0.000511006,0,-0.000258008,0,0.000344059,0,-0.000104288,
	0,0.000200637,0,-4.11781e-05,0,9.8184e-05,0,-1.63645e-05,0,3.67541e-05,0,-5.67089e-06,0,
	7.58757e-06,0,-7.01048e-07,0,-2.1816e-20
};

static const float kernel_44k[] = {
	1.11198e-19,0,8.51761e-06,0,-4.1494e-05,0,8.5171e-05,0,-0.000195542,0,0.000276408,0,
	-0.000528567,0,0.000661944,0,-0.00113833,0,0.00138664,0,-0.00215595,0,0.00269921,7.42767e-20,
	-0.00375866,6.36597e-06,0.00502052,-2.78574e-05,-0.00622305,5.96493e-05,0.00909232,-0.000132735,
	-0.0100965,0.000177632,0.0164042,-0.000362318,-0.0167728,0.000385214,0.030821,-0.000780205,
	-0.031153,0.000730921,0.0681576,-0.00144766,-0.0882324,0.00130872,0.261844,-0.00238871,
	0.0127836,0.00229372,-0.475152,-0.00354121,-0.17204,0.00398995,-0.200629,-0.00470137,0.940726,
	0.00688829,-0.0991544,-0.00546667,-0.019928,0.0117478,-0.05572,-0.00516137,-0.00408873,
	0.0197598,-0.0329885,-0.00266844,0.00266844,0.0329885,-0.0197598,0.00408873,0.00516137,0.05572,
	-0.0117478,0.019928,0.00546667,0.0991544,-0.00688829,0.059274,0.00470137,0.200629,-0.00398995,
	0.17204,0.00354121,0.475152,-0.00229372,-0.0127836,0.00238871,-0.261844,-0.00130872,0.0882324,
	0.00144766,-0.0681576,-0.000730921,0.031153,0.000780205,-0.030821,-0.000385214,0.0167728,
	0.000362318,-0.0164042,-0.000177632,0.0100965,0.000132735,-0.00909232,-5.96493e-05,0.00622305,
	2.78574e-05,-0.00502052,-6.36597e-06,0.00375866,-7.42767e-20,-0.00269921,0,0.00215595,0,
	-0.00138664,0,0.00113833,0,-0.000661944,0,0.000528567,0,-0.000276408,0,0.000195542,0,
	-8.5171e-05,0,4.1494e-05,0,-8.51761e-06,0,-1.11198e-19
};

int crossfeed_init(crossfeed_t *filter, int samplerate) {
	memset(filter, 0, sizeof(crossfeed_t));
	switch(samplerate) {
	case 96000:
		filter->filter = kernel_96k;
		filter->delay = 99;
		filter->len = 147;
		break;
	case 48000:
		filter->filter = kernel_48k;
		filter->delay = 49;
		filter->len = 73;
	case 44100:
		filter->filter = kernel_44k;
		filter->delay = 46;
		filter->len = 68;
	default:
		return -1;
	}
	return 0;
}

static inline void crossfeed_process_sample(crossfeed_t *filter, float left, float right,
                                            float *oleft, float *oright) {
	float tleft = (left - right) / 2;
	float mid = (left + right) / 2;
	float tright = (right - left) / 2;
	float toleft = 0, toright = 0;
	filter->left[filter->pos] = tleft;
	filter->mid[(filter->pos + filter->delay) % filter->len] = mid;
	filter->right[filter->pos] = tright;
	if(!filter->bypass) {
		for(unsigned int i=0;i<filter->len;++i) {
			toleft += filter->left[(filter->pos + filter->len - i) % filter->len] * filter->filter[2*i];
			toleft += filter->right[(filter->pos + filter->len - i) % filter->len] * filter->filter[2*i+1];
			toright += filter->right[(filter->pos + filter->len - i) % filter->len] * filter->filter[2*i];
			toright += filter->left[(filter->pos + filter->len - i) % filter->len] * filter->filter[2*i+1];
		}
	} else {
		toleft = filter->left[(filter->pos + filter->len - filter->delay) % filter->len];
		toright = filter->right[(filter->pos + filter->len - filter->delay) % filter->len];
	}
	*oleft = filter->mid[filter->pos] + 0.5*(toleft - toright);
	*oright = filter->mid[filter->pos] - 0.5*(toleft + toright);
	filter->pos = (filter->pos + 1) % filter->len;
}

void crossfeed_filter(crossfeed_t *filter, float *input, float *output, unsigned int size) {
	for(unsigned int i=0;i<size;++i) {
		crossfeed_process_sample(filter, input[i*2], input[i*2+1], &output[i*2],
		                         &output[i*2+1]);
	}
}

void crossfeed_filter_inplace_noninterleaved(crossfeed_t *filter, float *left, float *right,
                                             unsigned int size) {
	for(unsigned int i=0;i<size;++i) {
		crossfeed_process_sample(filter, left[i], right[i], &left[i],
		                         &right[i]);
	}
}
